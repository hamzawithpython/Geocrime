{% extends "crimeapp/base.html" %}

{% block title %}Google Maps Route Planner{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-4 space-y-6">



    <!-- Toggle Buttons -->
    <div class="flex justify-center gap-3">
        <button id="toggle-crime-markers" class="px-5 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">
            Toggle Crime Markers
        </button>
        <button id="toggle-heatmap" class="px-5 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition">
            Toggle Heatmap
        </button>
    </div>

    <!-- Responsive Map Container -->
    <div class="w-full rounded-xl overflow-hidden shadow-lg" style="height: 75vh; position: relative;">
        <div id="map" class="absolute inset-0" style="height: 100%; width: 100%;"></div>
            <!-- Floating search bar -->
                <div class="absolute top-6 left-1/2 transform -translate-x-1/2 z-20 w-full max-w-md px-4">
                    <input
                        id="floating-search"
                        type="text"
                        placeholder="🔍 Search a place..."
                        class="w-full p-3 rounded-full border border-blue-500 bg-white/90 backdrop-blur text-sm shadow-lg"
                    />
                </div>
        <!-- Floating Info Card -->
            <div id="click-info-card" class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-4 w-80 hidden z-20">
                <h3 class="font-semibold text-lg mb-2">Selected Location</h3>
                <p class="text-sm mb-1"><strong>Address:</strong> <span id="card-address">...</span></p>
                <p class="text-sm mb-1"><strong>Latitude:</strong> <span id="card-lat">...</span></p>
                <p class="text-sm mb-3"><strong>Longitude:</strong> <span id="card-lng">...</span></p>
                <button id="card-directions" class="mt-1 bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                    Get Directions
                </button>
            </div>

            <!-- Routing Input Card -->
            <div id="route-card" class="absolute bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 w-80 hidden z-20">
                <div>🚨 Crimes near this route: <strong id="crime-count"></strong></div>
                <div>🛑 Risk Level: <strong id="risk-level"></strong></div>
                <h3 class="font-semibold text-lg mb-2">Plan Your Route</h3>
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-600">Start Location:</label>
                    <input id="route-start" class="w-full mt-1 p-2 border rounded text-sm" placeholder="My Location">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-600">Destination:</label>
                    <input id="route-end" class="w-full mt-1 p-2 border rounded text-sm" readonly>
                </div>
                <button id="route-start-button" class="w-full bg-green-600 text-white py-2 px-3 rounded hover:bg-green-700 flex items-center justify-center gap-2">
                    <span id="start-button-spinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                    <span id="start-button-text">Start</span>
                </button>

            </div>
    </div>

</div>
{% endblock %}


{% block scripts %}
<script>
    let map, directionsService, directionsRenderer;
    let selectedMarker = null;
    let startMarker = null;
    let awaitingStartClick = false;
    let crimeMarkers = [];
    let heatmapLayer = null;
    let lastSelectedAddress = "";
    let destinationMarker = null;
    let activeInputField = null;
    let destinationSelected = false;
    let startSelected = false;
    let startAlertShown = false;
    let endAlertShown = false;



    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: {{ center_lat }}, lng: {{ center_lon }} },
            zoom: 13,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: "#3b82f6",
                strokeOpacity: 0.8,
                strokeWeight: 4
            }
        });

        document.getElementById("route-start").addEventListener("focus", () => {
            activeInputField = "start";
            if (!startAlertShown) {
                alert("Click on the map or search a place to select your Start Location.");
                startAlertShown = true;
            }
        });

        document.getElementById("route-end").addEventListener("focus", () => {
            activeInputField = "end";
            if (!endAlertShown) {
                alert("Click on the map or search a place to select your Destination.");
                endAlertShown = true;
            }
        });




        setupFloatingSearch();
        setupMapClickToGetAddress();
        loadCrimeData();
    }

    function setupFloatingSearch() {
        const input = document.getElementById("floating-search");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                alert("No location found for the input.");
                return;
            }

            const location = place.geometry.location;
            const address = place.formatted_address || place.name;
            document.getElementById("floating-search").value = address;

            map.setCenter(location);
            map.setZoom(15);

            const geocoder = new google.maps.Geocoder();

            // Handle based on which input is active
            if (activeInputField === "start") {
                if (startMarker) startMarker.setMap(null);
                startMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                });
                document.getElementById("route-start").value = address;

            } else if (activeInputField === "end") {
                if (selectedMarker) selectedMarker.setMap(null);
                selectedMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                });
                document.getElementById("route-end").value = address;
            }

            // Optionally update the floating info card
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === "OK" && results[0]) {
                    document.getElementById("card-address").textContent = results[0].formatted_address;
                    document.getElementById("card-lat").textContent = location.lat().toFixed(6);
                    document.getElementById("card-lng").textContent = location.lng().toFixed(6);
                    document.getElementById("click-info-card").classList.remove("hidden");
                } else {
                    console.error("Reverse geocoding failed: " + status);
                }
            });
        });
    }


    function setupMapClickToGetAddress() {
        const geocoder = new google.maps.Geocoder();
        const card = document.getElementById("click-info-card");
        const cardAddress = document.getElementById("card-address");
        const cardLat = document.getElementById("card-lat");
        const cardLng = document.getElementById("card-lng");
        const cardDirectionsBtn = document.getElementById("card-directions");

        map.addListener("click", function (e) {
            const clickedLatLng = e.latLng;

            // ✅ If user is selecting start location
            if (activeInputField === "start" || awaitingStartClick) {
                if (startMarker) startMarker.setMap(null);

                startMarker = new google.maps.Marker({
                    position: clickedLatLng,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                });

                geocoder.geocode({ location: clickedLatLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        document.getElementById("route-start").value = results[0].formatted_address;
                        if (awaitingStartClick) awaitingStartClick = false;
                    } else {
                        console.error("Reverse geocode failed: " + status);
                    }
                });

                return;
            }

            // ✅ If user is selecting destination location
            if (activeInputField === "end") {
                if (selectedMarker) selectedMarker.setMap(null);

                selectedMarker = new google.maps.Marker({
                    position: clickedLatLng,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                });

                geocoder.geocode({ location: clickedLatLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        document.getElementById("route-end").value = results[0].formatted_address;
                    } else {
                        console.error("Reverse geocode failed: " + status);
                    }
                });

                return;
            }

            // 🟡 Default case before clicking route inputs: show destination card
            if (selectedMarker) selectedMarker.setMap(null);
            selectedMarker = new google.maps.Marker({
                position: clickedLatLng,
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });

            geocoder.geocode({ location: clickedLatLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const address = results[0].formatted_address;
                    lastSelectedAddress = address;

                    cardAddress.textContent = address;
                    cardLat.textContent = clickedLatLng.lat().toFixed(6);
                    cardLng.textContent = clickedLatLng.lng().toFixed(6);
                    card.classList.remove("hidden");

                    cardDirectionsBtn.onclick = () => {
                        const routeCard = document.getElementById("route-card");
                        const routeStart = document.getElementById("route-start");
                        const routeEnd = document.getElementById("route-end");

                        routeStart.value = "";
                        awaitingStartClick = true;
                        activeInputField = "start";

                        alert("Click on the map to select your starting point.");
                        routeEnd.value = lastSelectedAddress;

                        routeCard.classList.remove("hidden");
                    };
                } else {
                    console.error("Geocoder failed: " + status);
                    card.classList.add("hidden");
                }
            });
        });

        // Optional: hide card & marker on zoom/drag when not selecting
        map.addListener("dragstart", function () {
            if (!awaitingStartClick && activeInputField !== "start" && selectedMarker) {
                selectedMarker.setMap(null);
                selectedMarker = null;
                card.classList.add("hidden");
            }
        });

        map.addListener("zoom_changed", function () {
            if (!awaitingStartClick && activeInputField !== "start" && selectedMarker) {
                selectedMarker.setMap(null);
                selectedMarker = null;
                card.classList.add("hidden");
            }
        });
    }






    function loadCrimeData() {
        fetch("/static/crime_data.json")
            .then(response => response.json())
            .then(data => {
                const heatmapData = [];

                data.forEach(crime => {
                    const lat = parseFloat(crime.Latitude);
                    const lon = parseFloat(crime.Longitude);
                    const type = crime["Primary Type"];
                    if (isNaN(lat) || isNaN(lon)) return;

                    heatmapData.push(new google.maps.LatLng(lat, lon));

                    let iconColor = "http://maps.google.com/mapfiles/ms/icons/green-dot.png";
                    if (["ASSAULT", "ROBBERY", "HOMICIDE"].includes(type)) {
                        iconColor = "http://maps.google.com/mapfiles/ms/icons/red-dot.png";
                    } else if (["BURGLARY", "BATTERY"].includes(type)) {
                        iconColor = "http://maps.google.com/mapfiles/ms/icons/orange-dot.png";
                    }

                    const marker = new google.maps.Marker({
                        position: { lat, lng: lon },
                        map: null,
                        icon: iconColor,
                        title: type
                    });

                    const infowindow = new google.maps.InfoWindow({
                        content: `<div class="p-2"><strong>${type}</strong><br>${crime.Description || ''}</div>`
                    });

                    marker.addListener("click", () => {
                        infowindow.open(map, marker);
                    });

                    crimeMarkers.push(marker);
                });

                heatmapLayer = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: null,
                    radius: 30
                });
            })
            .catch(error => console.error("Error loading crime data:", error));
    }

    function calculateAndDisplayRoute(start = null, end = null) {
        start = start || document.getElementById("start-location").value;
        end = end || document.getElementById("destination-location").value;

        if (!start || !end) {
            alert("Please enter both start and end locations.");
            return;
        }

        if (selectedMarker) selectedMarker.setMap(null);

        new google.maps.Marker({ position: start, map: map, icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" });
        new google.maps.Marker({ position: end, map: map, icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" });

        directionsService.route(
            {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING,
            },
            (response, status) => {
                if (status === "OK") {
                    directionsRenderer.setDirections(response);
                } else {
                    alert("Directions request failed: " + status);
                }
            }
        );
    }


    document.getElementById("toggle-crime-markers").addEventListener("click", () => {
        crimeMarkers.forEach(marker => {
            const visible = marker.getMap();
            marker.setMap(visible ? null : map);
        });
    });

    document.getElementById("toggle-heatmap").addEventListener("click", () => {
        if (heatmapLayer) {
            const visible = heatmapLayer.getMap();
            heatmapLayer.setMap(visible ? null : map);
        }
    });

    document.getElementById("route-start-button").addEventListener("click", async () => {
        if (!startMarker || !selectedMarker) {
            alert("Please select both start and destination on the map.");
            return;
        }

        // Toggle to loading state
        const btnText = document.getElementById("start-button-text");
        const btnSpinner = document.getElementById("start-button-spinner");
        btnText.textContent = "Loading...";
        btnSpinner.classList.remove("hidden");
        document.getElementById("route-start-button").disabled = true;

        const origin = {
            lat: startMarker.getPosition().lat(),
            lng: startMarker.getPosition().lng()
        };

        const destination = {
            lat: selectedMarker.getPosition().lat(),
            lng: selectedMarker.getPosition().lng()
        };

        const response = await fetch("/api/custom-route/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ origin, destination }),
        });

        const data = await response.json();

        // Reset loading state
        btnText.textContent = "Start";
        btnSpinner.classList.add("hidden");
        document.getElementById("route-start-button").disabled = false;

        if (response.ok && data.route) {
            const path = data.route.map(coord => ({
                lat: coord[0],
                lng: coord[1],
            }));

            new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 4,
                map: map
            });

            // Show route safety info from backend
            document.getElementById("crime-count").textContent = data.safety_info.nearby_crimes;
            document.getElementById("risk-level").textContent = data.safety_info.risk_level;
            document.getElementById("route-safety-info").classList.remove("hidden");


        } else {
            alert("Error generating safe route: " + (data.error || "Unknown error"));
            console.error(data.error);
        }
    });




    window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places,visualization&callback=initMap" async defer></script>
{% endblock %}
