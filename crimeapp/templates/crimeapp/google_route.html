{% extends "crimeapp/base.html" %}

{% block title %}Google Maps Route Planner{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-4 space-y-6">

    <!-- Toggle Buttons -->
    <div class="flex justify-center gap-3">
        <button id="toggle-crime-markers" class="px-5 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">
            Toggle Crime Markers
        </button>
        <button id="toggle-heatmap" class="px-5 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition">
            Toggle Heatmap
        </button>
    </div>

    <!-- Responsive Map Container -->
    <div class="w-full rounded-xl overflow-hidden shadow-lg" style="height: 75vh; position: relative;">
        <div id="map" class="absolute inset-0" style="height: 100%; width: 100%;"></div>

        <!-- Floating search bar -->
        <div class="absolute top-6 left-1/2 transform -translate-x-1/2 z-20 w-full max-w-md px-4">
            <input
                id="floating-search"
                type="text"
                placeholder="üîç Search a place..."
                class="w-full p-3 rounded-full border border-blue-500 bg-white/90 backdrop-blur text-sm shadow-lg"
            />
        </div>

        <!-- Floating Info Card -->
        <div id="click-info-card" class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-4 w-80 hidden z-20">
            <h3 class="font-semibold text-lg mb-2">Selected Location</h3>
            <p class="text-sm mb-1"><strong>Address:</strong> <span id="card-address">...</span></p>
            <p class="text-sm mb-1"><strong>Latitude:</strong> <span id="card-lat">...</span></p>
            <p class="text-sm mb-3"><strong>Longitude:</strong> <span id="card-lng">...</span></p>
            <button id="card-directions" class="mt-1 bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                Get Directions
            </button>
        </div>

        <!-- Routing Input Card -->
        <div id="route-card" class="absolute bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 w-80 hidden z-20">
            <div>üö® Crimes near this route: <strong id="crime-count"></strong></div>
            <div>üõë Risk Level: <strong id="risk-level"></strong></div>
            <h3 class="font-semibold text-lg mb-2">Plan Your Route</h3>
            <div class="mb-2 relative">
                <label class="block text-sm font-medium text-gray-600">Start Location:</label>
                <input id="route-start" class="w-full mt-1 p-2 pr-10 border rounded text-sm" placeholder="My Location">
                <button
                    type="button"
                    id="start-current-btn"
                    class="absolute right-2 top-9 text-blue-600 hover:text-blue-800"
                    title="Use Current Location"
                    aria-label="Use current location for start"
                >üìç</button>
            </div>

            <div class="mb-3 relative">
                <label class="block text-sm font-medium text-gray-600">Destination:</label>
                <input id="route-end" class="w-full mt-1 p-2 pr-10 border rounded text-sm" readonly>
                <button
                    type="button"
                    id="end-current-btn"
                    class="absolute right-2 top-9 text-blue-600 hover:text-blue-800"
                    title="Use Current Location"
                    aria-label="Use current location for destination"
                >üìç</button>
            </div>

            <button id="route-start-button" class="w-full bg-green-600 text-white py-2 px-3 rounded hover:bg-green-700 flex items-center justify-center gap-2">
                <span id="start-button-spinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                <span id="start-button-text">Start</span>
            </button>
        </div>
    </div>
</div>

<!-- Hidden trigger for Flowbite modal -->
<button id="open-missing-points-modal-trigger"
        type="button"
        class="hidden"
        data-modal-target="static-modal"
        data-modal-toggle="static-modal">
</button>

<!-- Flowbite Modal (reused for Missing Points and Get Directions prompts) -->
<div id="static-modal" data-modal-backdrop="static" tabindex="-1" aria-hidden="true"
     class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50
            justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
        <h3 id="mpm-title" class="text-lg font-semibold text-gray-900 dark:text-white">
          Select Start & Destination
        </h3>
        <button type="button"
                class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm
                       w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                data-modal-hide="static-modal" aria-label="Close">
          ‚úñ
        </button>
      </div>

      <!-- Modal body -->
      <div class="p-4 md:p-5 space-y-3">
        <p id="mpm-body" class="text-sm leading-relaxed text-gray-600 dark:text-gray-300">
          You need both a <b>Start</b> and <b>Destination</b> inside Chicago to generate a safe route.
        </p>
        <ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-300">
          <li>Click on the map</li>
          <li>or use <em>Use Current Location</em></li>
          <li>or search via the floating search box</li>
        </ul>
      </div>

      <!-- Modal footer -->
      <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
        <button id="modal-pick-start"
                type="button"
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none
                       focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center
                       dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                data-modal-hide="static-modal">
          Pick Start on Map
        </button>
        <button id="modal-use-current"
                type="button"
                class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg
                       border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4
                       focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400
                       dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700"
                data-modal-hide="static-modal">
          Use Current Location
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="fixed right-4 top-4 z-[100] space-y-2 pointer-events-none"></div>
<div id="toast-center-container" class="fixed inset-0 flex items-center justify-center z-50 pointer-events-none"></div>

{% endblock %}


{% block scripts %}
<!-- Flowbite (for Tailwind components like modal) -->
<script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js" defer></script>

<script>
    let map, directionsService, directionsRenderer;
    let selectedMarker = null;
    let startMarker = null;
    let awaitingStartClick = false;
    let crimeMarkers = [];
    let heatmapLayer = null;
    let lastSelectedAddress = "";
    let destinationMarker = null;
    let activeInputField = null;
    let destinationSelected = false;
    let startSelected = false;
    let startAlertShown = false;
    let endAlertShown = false;
    let crimeInfoWindow = null;

    function showToast(message, variant = "info", timeout = 3000) {
      const id = "toast-" + Date.now();
      const box = document.createElement("div");

      const colors = {
        info:    "border-blue-200",
        success: "border-green-200",
        warning: "border-yellow-200",
        error:   "border-red-200",
      };
      const icons = {
        info:    "‚ÑπÔ∏è",
        success: "‚úÖ",
        warning: "‚ö†Ô∏è",
        error:   "‚ùå",
      };

      // Default style
      let textColor = "text-gray-700 dark:text-gray-200";
      let container = document.getElementById("toast-container");
      let alignment = "flex w-80 items-center rounded-lg bg-white p-4 shadow border";

      // Special styling for "Tip" messages
      if (message.startsWith("Tip:")) {
        textColor = "text-blue-600 dark:text-blue-400 font-medium";
        container = document.getElementById("toast-center-container"); // use center container
        alignment = "flex w-[28rem] items-center justify-center rounded-lg bg-white p-6 shadow border";
      }

      box.id = id;
      box.role = "alert";
      box.className = `pointer-events-auto ${alignment} ${(colors[variant] || colors.info)}`;

      box.innerHTML = `
        <div class="mr-3">${icons[variant] || icons.info}</div>
        <div class="text-sm ${textColor}">${message}</div>
        <button type="button" class="ml-auto inline-flex h-6 w-6 items-center justify-center rounded hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Close">‚úñ</button>
      `;

      container.appendChild(box);

      const closeBtn = box.querySelector("button");
      const remove = () => box.remove();

      closeBtn.onclick = remove;
      if (timeout) setTimeout(remove, timeout);
    }



    // ---- Open Flowbite modal programmatically ----
    function openMissingPointsModal(titleText, bodyHtml) {
      if (titleText) document.getElementById("mpm-title").textContent = titleText;
      if (bodyHtml)  document.getElementById("mpm-body").innerHTML = bodyHtml;
      const trigger = document.getElementById("open-missing-points-modal-trigger");
      if (trigger) trigger.click();
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: {{ center_lat }}, lng: {{ center_lon }} },
            zoom: 13,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: "#3b82f6",
                strokeOpacity: 0.8,
                strokeWeight: 4
            }
        });

        // One shared InfoWindow for all crime markers
        crimeInfoWindow = new google.maps.InfoWindow();

        // Close it on map interactions
        map.addListener("click", () => crimeInfoWindow.close());
        map.addListener("dragstart", () => crimeInfoWindow.close());
        map.addListener("zoom_changed", () => crimeInfoWindow.close());

        // Replace focus alerts with toasts
        document.getElementById("route-start").addEventListener("focus", () => {
            activeInputField = "start";
            if (!startAlertShown) {
                showToast("Tip: Click on the map or use search to set your Start.", "info", 2500);
                startAlertShown = true;
            }
        });
        document.getElementById("route-end").addEventListener("focus", () => {
            activeInputField = "end";
            if (!endAlertShown) {
                showToast("Tip: Click on the map or use search to set your Destination.", "info", 2500);
                endAlertShown = true;
            }
        });

        setupFloatingSearch();
        setupMapClickToGetAddress();
        loadCrimeData();
    }

    function setupFloatingSearch() {
        const input = document.getElementById("floating-search");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                showToast("No location found for the input.", "warning");
                return;
            }

            const location = place.geometry.location;
            const address = place.formatted_address || place.name;
            document.getElementById("floating-search").value = address;

            map.setCenter(location);
            map.setZoom(15);

            const geocoder = new google.maps.Geocoder();

            // Handle based on which input is active
            if (activeInputField === "start") {
                if (startMarker) startMarker.setMap(null);
                startMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                });
                document.getElementById("route-start").value = address;

            } else if (activeInputField === "end") {
                if (selectedMarker) selectedMarker.setMap(null);
                selectedMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                });
                document.getElementById("route-end").value = address;
            }

            // Optionally update the floating info card
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === "OK" && results[0]) {
                    document.getElementById("card-address").textContent = results[0].formatted_address;
                    document.getElementById("card-lat").textContent = location.lat().toFixed(6);
                    document.getElementById("card-lng").textContent = location.lng().toFixed(6);
                    document.getElementById("click-info-card").classList.remove("hidden");
                } else {
                    console.error("Reverse geocoding failed: " + status);
                }
            });
        });
    }

    function setupMapClickToGetAddress() {
        const geocoder = new google.maps.Geocoder();
        const card = document.getElementById("click-info-card");
        const cardAddress = document.getElementById("card-address");
        const cardLat = document.getElementById("card-lat");
        const cardLng = document.getElementById("card-lng");
        const cardDirectionsBtn = document.getElementById("card-directions");

        map.addListener("click", function (e) {
            const clickedLatLng = e.latLng;

            // ‚úÖ If user is selecting start location
            if (activeInputField === "start" || awaitingStartClick) {
                if (startMarker) startMarker.setMap(null);

                startMarker = new google.maps.Marker({
                    position: clickedLatLng,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                });

                geocoder.geocode({ location: clickedLatLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        document.getElementById("route-start").value = results[0].formatted_address;
                        if (awaitingStartClick) awaitingStartClick = false;
                    } else {
                        console.error("Reverse geocode failed: " + status);
                    }
                });

                return;
            }

            // ‚úÖ If user is selecting destination location
            if (activeInputField === "end") {
                if (selectedMarker) selectedMarker.setMap(null);

                selectedMarker = new google.maps.Marker({
                    position: clickedLatLng,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                });

                geocoder.geocode({ location: clickedLatLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        document.getElementById("route-end").value = results[0].formatted_address;
                    } else {
                        console.error("Reverse geocode failed: " + status);
                    }
                });

                return;
            }

            // üü° Default case before clicking route inputs: show destination card
            if (selectedMarker) selectedMarker.setMap(null);
            selectedMarker = new google.maps.Marker({
                position: clickedLatLng,
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });

            geocoder.geocode({ location: clickedLatLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const address = results[0].formatted_address;
                    lastSelectedAddress = address;

                    cardAddress.textContent = address;
                    cardLat.textContent = clickedLatLng.lat().toFixed(6);
                    cardLng.textContent = clickedLatLng.lng().toFixed(6);
                    card.classList.remove("hidden");

                    // Get Directions button ‚Üí open Flowbite modal
                    cardDirectionsBtn.onclick = () => {
                        const routeCard = document.getElementById("route-card");
                        const routeStart = document.getElementById("route-start");
                        const routeEnd = document.getElementById("route-end");

                        routeStart.value = "";
                        awaitingStartClick = true;
                        activeInputField = "start";
                        routeEnd.value = lastSelectedAddress;
                        routeCard.classList.remove("hidden");

                        openMissingPointsModal(
                          "Pick your Start Location",
                          "Click anywhere on the map to choose your <b>Start</b>, or use one of the options below."
                        );

                        const pickStartBtn = document.getElementById("modal-pick-start");
                        const useCurrentBtn = document.getElementById("modal-use-current");
                        if (pickStartBtn) pickStartBtn.onclick = () => { activeInputField = "start"; };
                        if (useCurrentBtn) useCurrentBtn.onclick = () => setCurrentLocation("start");
                    };
                } else {
                    console.error("Geocoder failed: " + status);
                    card.classList.add("hidden");
                }
            });
        });

        // Optional: hide card & marker on zoom/drag when not selecting
        map.addListener("dragstart", function () {
            if (!awaitingStartClick && activeInputField !== "start" && selectedMarker) {
                selectedMarker.setMap(null);
                selectedMarker = null;
                card.classList.add("hidden");
            }
        });

        map.addListener("zoom_changed", function () {
            if (!awaitingStartClick && activeInputField !== "start" && selectedMarker) {
                selectedMarker.setMap(null);
                selectedMarker = null;
                card.classList.add("hidden");
            }
        });
    }

    function setCurrentLocation(target) {
        if (!navigator.geolocation) {
            showToast("Geolocation is not supported by your browser.", "warning");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const currentLatLng = new google.maps.LatLng(lat, lng);

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: currentLatLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        const address = results[0].formatted_address;

                        if (target === "start") {
                            document.getElementById("route-start").value = address;
                            if (startMarker) startMarker.setMap(null);
                            startMarker = new google.maps.Marker({
                                position: currentLatLng,
                                map: map,
                                icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                            });
                        } else if (target === "end") {
                            document.getElementById("route-end").value = address;
                            if (selectedMarker) selectedMarker.setMap(null);
                            selectedMarker = new google.maps.Marker({
                                position: currentLatLng,
                                map: map,
                                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                            });
                        }

                        map.setCenter(currentLatLng);
                        map.setZoom(15);

                        document.getElementById("card-address").textContent = address;
                        document.getElementById("card-lat").textContent = lat.toFixed(6);
                        document.getElementById("card-lng").textContent = lng.toFixed(6);
                        document.getElementById("click-info-card").classList.remove("hidden");
                    } else {
                        console.error("Reverse geocode failed:", status);
                        showToast("Could not determine an address for your current location.", "warning");
                    }
                });
            },
            (error) => {
                console.error("Geolocation error:", error);
                const msg =
                    error.code === error.PERMISSION_DENIED
                        ? "Location permission denied. You can still click on the map or use the search box."
                        : "Unable to get your current location. Please try again.";
                showToast(msg, "warning");
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    function loadCrimeData() {
        fetch("/static/crime_data.json")
            .then(response => response.json())
            .then(data => {
                const heatmapData = [];

                data.forEach(crime => {
                    const lat = parseFloat(crime.Latitude);
                    const lon = parseFloat(crime.Longitude);
                    const type = crime["Primary Type"];
                    if (isNaN(lat) || isNaN(lon)) return;

                    heatmapData.push(new google.maps.LatLng(lat, lon));

                    let iconColor = "http://maps.google.com/mapfiles/ms/icons/green-dot.png";
                    if (["ASSAULT", "ROBBERY", "HOMICIDE"].includes(type)) {
                        iconColor = "http://maps.google.com/mapfiles/ms/icons/red-dot.png";
                    } else if (["BURGLARY", "BATTERY"].includes(type)) {
                        iconColor = "http://maps.google.com/mapfiles/ms/icons/orange-dot.png";
                    }

                    const marker = new google.maps.Marker({
                        position: { lat, lng: lon },
                        map: null,
                        icon: iconColor,
                        title: type
                    });

                    marker.addListener("click", () => {
                        const html = `<div class="p-2">
                            <strong>${type}</strong><br>${crime.Description || ""}
                        </div>`;
                        if (!crimeInfoWindow) {
                            crimeInfoWindow = new google.maps.InfoWindow();
                        }
                        crimeInfoWindow.close();
                        crimeInfoWindow.setContent(html);
                        crimeInfoWindow.open({ anchor: marker, map: map, shouldFocus: false });
                    });

                    crimeMarkers.push(marker);
                });

                heatmapLayer = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: null,
                    radius: 30
                });
            })
            .catch(error => console.error("Error loading crime data:", error));
    }

    function calculateAndDisplayRoute(start = null, end = null) {
        start = start || document.getElementById("start-location")?.value;
        end = end || document.getElementById("destination-location")?.value;

        if (!start || !end) {
            showToast("Please enter both start and end locations.", "warning");
            return;
        }

        if (selectedMarker) selectedMarker.setMap(null);

        new google.maps.Marker({ position: start, map: map, icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" });
        new google.maps.Marker({ position: end, map: map, icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" });

        directionsService.route(
            {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING,
            },
            (response, status) => {
                if (status === "OK") {
                    directionsRenderer.setDirections(response);
                } else {
                    showToast("Directions request failed: " + status, "error");
                }
            }
        );
    }

    document.getElementById("toggle-crime-markers").addEventListener("click", () => {
        if (crimeInfoWindow) crimeInfoWindow.close();
        crimeMarkers.forEach(marker => {
            const visible = marker.getMap();
            marker.setMap(visible ? null : map);
        });
    });

    document.getElementById("toggle-heatmap").addEventListener("click", () => {
        if (heatmapLayer) {
            const visible = heatmapLayer.getMap();
            heatmapLayer.setMap(visible ? null : map);
        }
    });

    document.getElementById("start-current-btn").addEventListener("click", () => setCurrentLocation("start"));
    document.getElementById("end-current-btn").addEventListener("click", () => setCurrentLocation("end"));

    document.getElementById("route-start-button").addEventListener("click", async () => {
        if (!startMarker || !selectedMarker) {
            openMissingPointsModal(
              "Select Start & Destination",
              "You need both a <b>Start</b> and <b>Destination</b> inside Chicago."
            );

            const pickStartBtn = document.getElementById("modal-pick-start");
            const useCurrentBtn = document.getElementById("modal-use-current");

            if (pickStartBtn) {
                pickStartBtn.onclick = () => {
                    activeInputField = "start";
                    const routeCard = document.getElementById("route-card");
                    if (routeCard) routeCard.classList.remove("hidden");
                    showToast("Now click on the map to choose your Start.", "info", 2500);
                };
            }
            if (useCurrentBtn) {
                useCurrentBtn.onclick = () => setCurrentLocation("start");
            }
            return;
        }

        // Toggle to loading state
        const btnText = document.getElementById("start-button-text");
        const btnSpinner = document.getElementById("start-button-spinner");
        btnText.textContent = "Loading...";
        btnSpinner.classList.remove("hidden");
        document.getElementById("route-start-button").disabled = true;

        const origin = {
            lat: startMarker.getPosition().lat(),
            lng: startMarker.getPosition().lng()
        };

        const destination = {
            lat: selectedMarker.getPosition().lat(),
            lng: selectedMarker.getPosition().lng()
        };

        const response = await fetch("/api/custom-route/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ origin, destination }),
        });

        const data = await response.json();

        // Reset loading state
        btnText.textContent = "Start";
        btnSpinner.classList.add("hidden");
        document.getElementById("route-start-button").disabled = false;

        if (response.ok && data.route) {
            const path = data.route.map(coord => ({
                lat: coord[0],
                lng: coord[1],
            }));

            new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 4,
                map: map
            });

            // Show route safety info from backend
            document.getElementById("crime-count").textContent = data.safety_info.nearby_crimes;
            document.getElementById("risk-level").textContent = data.safety_info.risk_level;
            document.getElementById("route-safety-info")?.classList?.remove("hidden");

        } else {
            let userMessage = "An error occurred while generating your route.";
            let action = "";

            switch (data.code) {
                case "MISSING_POINTS":
                    userMessage = "You must select both a start and destination.";
                    action = "Pick both points and try again.";
                    break;
                case "OUT_OF_BOUNDS":
                    userMessage = "Selected points are outside the Chicago map area.";
                    action = "Select a location inside Chicago.";
                    break;
                case "NO_PATH":
                    userMessage = "No safe path could be found between your points.";
                    action = "Adjust your start or destination.";
                    break;
                case "SERVER_ERROR":
                    userMessage = "A server error occurred.";
                    action = "Please retry in a moment.";
                    break;
                default:
                    userMessage = "Unknown error: " + (data.error || "Please retry.");
                    action = "Try again.";
            }

            showToast(`${userMessage} ${action ? " ‚Äî " + action : ""}`, "error", 4000);
            console.error("Route error:", data);
        }
    });

    window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places,visualization&callback=initMap" async defer></script>
{% endblock %}
